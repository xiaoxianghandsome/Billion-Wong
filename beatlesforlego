# 导入 PySimpleGUI 模块
import PySimpleGUI as sg

# 导入其他需要的模块
import os
import cv2
import numpy as np

# 定义一个函数，用来把图片转换成乐高风格
def legoify(image):
    # 读取图片
    img = cv2.imread(image)
    # 缩小图片
    img = cv2.resize(img, (0, 0), fx=0.1, fy=0.1)
    # 转换成灰度图
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    # 二值化处理
    _, thresh = cv2.threshold(gray, 127, 255, cv2.THRESH_BINARY)
    # 找到轮廓
    contours, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
    # 创建一个空白画布
    canvas = np.zeros_like(img)
    # 遍历每个轮廓
    for cnt in contours:
        # 计算轮廓的面积
        area = cv2.contourArea(cnt)
        # 如果面积小于阈值，跳过
        if area < 10:
            continue
        # 计算轮廓的最小外接矩形
        x, y, w, h = cv2.boundingRect(cnt)
        # 在画布上画出矩形，颜色随机，填充满
        canvas[y:y+h, x:x+w] = np.random.randint(0, 256, size=(3,))
    # 返回画布
    return canvas

# 定义一个函数，用来显示图片
def show_image(image):
    # 获取图片的宽度和高度
    width, height = image.shape[1], image.shape[0]
    # 转换成字节流格式
    bytes = cv2.imencode(".png", image)[1].tobytes()
    # 创建一个图像元素，设置大小和数据源
    image_elem = sg.Image(data=bytes, size=(width, height))
    # 创建一个窗口，设置标题和布局
    window = sg.Window("Image", [[image_elem]])
    # 显示窗口，等待用户关闭或按下 ESC 键
    while True:
        event, values = window.read()
        if event == sg.WIN_CLOSED or event == "Escape":
            break
    # 关闭窗口
    window.close()

# 创建一个文件选择器元素，设置标题和初始文件夹路径
file_selector = sg.FileBrowse("请选择你的图片", initial_folder=os.getcwd())
# 创建一个下拉菜单元素，设置可选项和默认值
dropdown_menu = sg.Combo(["原图", "乐高风格"], default_value="原图")
# 创建一个按钮元素，设置文本和键值
button = sg.Button("执行", key="-EXECUTE-")
# 创建一个窗口，设置标题和布局
window = sg.Window("乐高模拟器", [[file_selector], [dropdown_menu], [button]])
# 进入事件循环，等待用户操作
while True:
    event, values = window.read()
    # 如果用户关闭窗口或按下 ESC 键，退出循环
    if event == sg.WIN_CLOSED or event == "Escape":
        break
    # 如果用户点击执行按钮，获取文件路径和选项值，并执行相应的操作
    if event == "-EXECUTE-":
        file_path = values[0]
        option = values[1]
        if file_path and option:
            if option == "原图":
                image = cv2.imread(file_path)
                show_image(image)
            elif option == "乐高风格":
                image = legoify(file_path)
                show_image(image)
# 关闭窗口            
window.close()
